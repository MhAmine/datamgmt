---
title: "Datamgmt vignette"
author: "Data Science Fellows Spring 2018"
date: "`r Sys.Date()`"
output: 
    rmarkdown::html_vignette:
        toc: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

# Functions for regular ADC/SASAP workflows

## Quality Assurance for Data Packages

Purpose: use `qa_package` to check a DataONE EML package. Will check that attributes match values in the data.

Note: this function also calls qa_attributes and passes the data object and associated dataTable, but that function can also be called directly.

Example:

```{r}
qa_package(mn, pid, 
           readAllData = FALSE, 
           check_attributes = TRUE, 
           check_creators = FALSE, 
           check_access = FALSE)
```

## Create attributes tables

The `create_attributes_table` allows editing of an attribute table and custom units table in a shiny environment

Example:

```{r}
create_attributes_table(NULL, NULL)

data <- read.csv("Test.csv")
create_attributes_table(data, NULL)

attributes_table <- EML::get_attributes(eml@dataset@dataTable[[i]]@attributeList)$attributes
create_attributes_table(NULL, attributes_table)

create_attributes_table(data, attributes_table)
```

## Get custom unit data frame

The `get_custom_units` function uses the udunits2 unit library to format inputted unit into an EML unit form.

Example:

```{r}
#The following all return the same data frame.
get_custom_units('kilometersPerSquareSecond') #preferred input form
get_custom_units('Kilometers per seconds squared')
get_custom_units('km/s^2')
get_custom_units('km s-2')
get_custom_units('s-2 /     kilometers-1') #works but is not advised
```


## Adding an ORCID to a creator

A complete data package requires that at minimum one creator includes an associated ORCID ID. The function `add_creator_id` allows you to add an ORCID or reference ID to any creator in EML.

The function invisibly returns the full EML, which can be saved to a variable. It also prints the changed creator entry so that it's easy to check that the appropriate change was made. In addition to the EML, at least one of either the orcid or reference id is required.

Note: updated creator information cannot be used as a reference for associatedParties because the extra "role" field is required. Also, the function does not (yet) account for cases in which multiple creators have the same surname.

Example:

```{r}
eml_path <- file.path(system.file(package = "datamgmt"), "dummy_meta_full.xml")
eml <- EML::read_eml(eml_path_original)
add_creator_id(eml, orcid = "https://orcid.org/WWWW-XXXX-YYYY-ZZZZ")

eml <- eml %>%
           add_creator_id(surname = "high-stakes",
                          orcid = "https://orcid.org/0000-1234-5678-4321",
                          id = "henrietta")

#use references to add updated contact info to Henrietta's other roles
eml@dataset@contact[[1]] <- new('contact', reference = "henrietta")
eml@dataset@metadataProvider[[1]] <- new('metadataProvider', reference = "henrietta")

```

# Functions for PI's

## Download package

The `download_package` function downloads all of the Data Objects in a Data Package to the local filesystem. It is particularly useful when a Data Package is too large to download using the web interface.

Setting check_download_size to TRUE is recommended if you are uncertain of the total download size and want to avoid downloading very large Data Packages.

This function will also download any data objects it finds in any child Data Packages of the input data package. If you would only like to download data from one Data Package, set download_child_packages to FALSE.

Example:

```{r}
cn <- CNode("PROD")
mn <- getMNode(cn, "urn:node:ARCTIC")
download_package(mn, "resource_map_urn:uuid:2b4e4174-4e4b-4a46-8ab0-cc032eda8269")
```

# Functions for advanced metadata edits/package development

## Clone or download packages

The `clone_package` function copies a Data Package from one DataOne member node to another. It can also be used to copy an older version of a Data Package to the same member node in order to restore it, provided that the old Package is then obsoleted by the copied version.

NOTE: BUGS ARE CURRENTLY BEING FIXED

Example:

```{r}
cn_pull <- CNode("PROD")
mn_pull <- getMNode(cn_pull, "urn:node:ARCTIC")
cn_push <- CNode('STAGING')
mn_push <- getMNode(cn_push,'urn:node:mnTestARCTIC')
clone_package(mn_pull, mn_push, "resource_map_doi:10.18739/A2RZ6X")
```

## Create a dummy package

The function `create_dummy_package2` creates a fuller package than create_dummy_package but is otherwise based on the same concept. This dummy package includes multiple data objects (2 csv's, and 2 jpg's), responsible parties, geographic locations, method steps, etc. You can also define a unique title for the package to distinguish it from other test packages.

```{r}
create_dummy_package2(mn, title = "A Dummy Package")
```

## Get NSF awards

The `get_awards` function uses the NSF API to get all records pertaining to the Arctic or Polar programs.

Example:

```{r}
all_awards <- get_awards()
new_awards <- get_awards(from_date = "01/01/2017")
```

## Which in EML

The `which_in_eml` function returns indices within an EML list that contain an instance where test == TRUE. See examples for more information.

```{r}
# Question: Which creators have a surName "Smith"?
n <- which_in_eml(eml@dataset@creator, "surName", "Smith")
# Answer: eml@dataset@creator[n]

# Question: Which dataTables have an entityName that begins with "2016"
n <- which_in_eml(eml@dataset@dataTable, "entityName", function(x) {grepl("^2016", x)})
# Answer: eml@dataset@dataTable[n]

# Question: Which attributes in dataTable[[1]] have a numberType "natural"?
n <- which_in_eml(eml@dataset@dataTable[[1]]@attributeList@attribute, "numberType", "natural")
# Answer: eml@dataset@dataTable[[1]]@attributeList@attribute[n]

# Question: Which dataTables have at least one attribute with a numberType "natural"?
n <- which_in_eml(eml@dataset@dataTable, "numberType", function(x) {"natural" %in% x})
# Answer: eml@dataset@dataTable[n]
```

